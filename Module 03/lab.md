Лабораторная работа: Запрос нескольких таблиц


Упражнение 1: Написание запросов, использующих внутренние соединения
```
Задача 1: Подготовка лабораторной среды
1. Убедитесь, что виртуальные машины 20761C-MIA-DC и 20761C-MIA-SQL запущены, а затем войдите в 20761C-MIA-SQL
как ADVENTUREWORKS\Student с паролем Pa55w.rd.
2. В папке D:\Labfiles\Lab04\Starter щелкните правой кнопкой мыши Setup.cmd и выберите Запуск от имени администратора.
3. В диалоговом окне «Контроль учетных записей пользователей» щелкните Да.
4. В командной строке введите y, нажмите Enter, дождитесь завершения скрипта и нажмите любую клавишу.
Задача 2: Напишите оператор SELECT, использующий внутреннее соединение
1. На панели задач щелкните Microsoft SQL Server Management Studio.
2. В диалоговом окне «Подключение к серверу» в поле «Имя сервера» введите MIA-SQL и нажмите
Подключиться.
3. В меню Файл выберите Открыть и нажмите Проект/Решение.
4. В диалоговом окне Открыть проект перейдите в папку D:\Labfiles\Lab04\Starter\Project и дважды щелкните Project.ssmssln.
5. В обозревателе решений разверните Запросы и дважды щелкните 51 - Лабораторная работа 1.sql.
6. В окне запроса выделите оператор USE TSQL; и нажмите Выполнить.
7. В панели запроса после описания Задачи 1 введите следующий запрос:
SELECT
p.productname, c.categoryname
FROM Production.Products AS p
INNER JOIN Production.Categories AS c ON p.categoryid = c.categoryid;
8. Выделите написанный запрос и нажмите «Выполнить».
9. Посмотрите на результат и ответьте на следующие вопросы:

Какой столбец вы указали в качестве предиката в предложении ON соединения? Почему?
В этом запросе столбец categoryid является предикатом. Интуитивно большинство людей скажут, что это предикат,
 поскольку столбец существует в обеих входных таблицах. Кстати, использование одного и того же
имени для столбцов, содержащих одни и те же данные, но в разных таблицах, является хорошей практикой в
​​моделировании данных. Другая возможность — проверка ссылочной целостности с помощью первичной и внешней
ключевой информации с помощью SQL Server Management Studio. Если ограничений первичного или внешнего ключа
 нет, вам придется получить информацию о модели данных у разработчика.

Допустим, в таблице Production.Categories есть новая строка, и эта новая категория продуктов не имеет
связанных с ней продуктов в таблице Production.Products. Будет ли эта строка включена в результат оператора SELECT, написанного в описании задачи 1?
Нет, потому что внутреннее соединение извлекает только соответствующие строки на основе предиката из обеих
входных таблиц. Поскольку новое значение для categoryid отсутствует в столбце categoryid в таблице
 Запрос данных с помощью Transact-SQL
Production.Products, в результате оператора SELECT
не будет соответствующих строк.
Результаты: После этого упражнения вы должны знать, как использовать внутреннее соединение между двумя таблицами.
```
Упражнение 2: Написание запросов, использующих внутренние соединения нескольких таблиц
```
Задание 1: Выполнение оператора T-SQL
1. В обозревателе решений дважды щелкните запрос 61 - Lab Exercise 2.sql.
2. В окне запроса выделите оператор USE TSQL; и нажмите кнопку Выполнить.
3. Под описанием задания 1 выделите написанный запрос и нажмите кнопку Выполнить.
4. Обратите внимание на сообщение об ошибке:
Неоднозначное имя столбца 'custid'.
5. Эта ошибка произошла, потому что столбец custid присутствует в обеих таблицах; вам нужно указать, из какой
таблицы вы хотите получить значения столбцов.

Задача 2: применить необходимые изменения и выполнить оператор T-SQL
1. Выделите предыдущий запрос и в меню Правка нажмите Копировать.
2. В окне запроса щелкните строку после описания Задачи 2 и в меню Правка нажмите Вставить.
3. Добавьте префикс столбца Customers к существующему запросу, чтобы он выглядел следующим образом:
SELECT
Customers.custid, contactname, orderid
FROM Sales.Customers
INNER JOIN Sales.Orders ON Customers.custid = Orders.custid;
4. Выделите измененный запрос и нажмите Выполнить.

Задача 3: Изменение псевдонимов таблиц
1. Выделите предыдущий запрос и в меню «Правка» нажмите «Копировать».
2. В окне запроса нажмите строку после описания задачи 3 и в меню «Правка» нажмите «Вставить».
3. Измените оператор T-SQL, чтобы использовать псевдонимы таблиц. Ваш запрос должен выглядеть следующим образом:
SELECT
c.custid, c.contactname, o.orderid
FROM Sales.Customers AS c
INNER JOIN Sales.Orders AS o ON c.custid = o.custid;
4. Выделите написанный запрос и нажмите «Выполнить».
5. Сравните эти результаты с результатами задачи 2.
6. Измените оператор T-SQL, чтобы включить полное имя исходной таблицы в качестве префикса столбца. Ваш запрос
теперь должен выглядеть так:
SELECT
Customers.custid, Customers.contactname, Orders.orderid
FROM Sales.Customers AS c
INNER JOIN Sales.Orders AS o ON c.custid = o.custid;
7. Выделите написанный запрос и нажмите Execute.
8. Обратите внимание на сообщения об ошибках:
Msg 4104, Level 16, State 1, Line 57
Не удалось привязать составной идентификатор "Customers.custid".
Msg 4104, Level 16, State 1, Line 57
Не удалось привязать составной идентификатор "Customer.contactname"

Вы получили эти сообщения об ошибках, поскольку, поскольку вы используете другой псевдоним таблицы, полное имя исходной
таблицы, на которое вы ссылаетесь как на префикс столбца, больше не существует. Помните, что предложение SELECT
вычисляется после предложения FROM, поэтому вы должны использовать псевдонимы таблиц при указании столбцов в предложении SELECT.
9. Измените оператор SELECT так, чтобы он использовал правильные псевдонимы таблиц. Ваш запрос должен выглядеть следующим образом:
SELECT
c.custid, c.contactname, o.orderid
FROM Sales.Customers AS c
INNER JOIN Sales.Orders AS o ON c.custid = o.custid;
10. Выделите написанный запрос и нажмите Выполнить.

Задача 4: Добавить дополнительную таблицу и столбцы
1. В панели запросов после описания задачи 4 введите следующий запрос:
SELECT
c.custid, c.contactname, o.orderid, d.productid, d.qty, d.unitprice
FROM Sales.Customers AS c
INNER JOIN Sales.Orders AS o ON c.custid = o.custid
INNER JOIN Sales.OrderDetails AS d ON d.orderid = o.orderid;
2. Выделите написанный запрос и нажмите «Выполнить».
3. Посмотрите на результат. Помните, что при наличии внутреннего соединения с несколькими таблицами логическая обработка запроса отличается от физической реализации. В этом случае это означает, что вы не можете гарантировать порядок, в котором оптимизатор SQL Server будет обрабатывать таблицы. Например, вы
не можете гарантировать, что таблица Sales.Customers будет сначала объединена с таблицей Sales.Orders, а
затем с таблицей Sales.OrderDetails.
Результаты: После этого упражнения вы должны лучше понимать, почему важны псевдонимы и как
выполнять объединение нескольких таблиц. Запрос данных с помощью Transact-SQL
```
Упражнение 3: Написание запросов, использующих самообъединения
```
Задание 1: Написание простого оператора SELECT
1. В обозревателе решений дважды щелкните запрос 71 - Lab Exercise 3.sql.
2. В окне запроса выделите оператор USE TSQL; и нажмите кнопку Execute.
3. В панели запросов после описания задачи 1 введите следующий запрос:
SELECT
e.empid, e.lastname, e.firstname, e.title, e.mgrid
FROM HR.Employees AS e;
4. Выделите написанный запрос и нажмите «Выполнить».
5. Обратите внимание, что запрос извлек девять строк.

Задача 2: Написать запрос, использующий самообъединение
1. Выделите предыдущий запрос и в меню «Правка» нажмите «Копировать».
2. В окне запросов после описания задачи 2 нажмите строку и в меню «Правка» нажмите «Вставить».
3. Измените запрос, добавив самообъединение, чтобы получить информацию о менеджерах. Запрос должен выглядеть
так:
SELECT
e.empid, e.lastname, e.firstname, e.title, e.mgrid,
m.lastname AS mgrlastname, m.firstname AS mgrfirstname
FROM HR.Employees AS e
INNER JOIN HR.Employees AS m ON e.mgrid = m.empid;

4. Выделите написанный запрос и нажмите Выполнить.
5. Обратите внимание, что запрос извлек восемь строк, и ответьте на следующие вопросы:
Обязательно ли использовать псевдонимы таблиц при написании оператора с самосоединением? Можно ли использовать полное
имя исходной таблицы в качестве псевдонима?
Вы должны использовать псевдонимы таблиц. Вы не можете использовать полное имя исходной таблицы в качестве псевдонима при ссылке на
обе входные таблицы. В конечном итоге вы можете использовать полное имя исходной таблицы в качестве псевдонима для одной входной таблицы
и другой псевдоним для второй входной таблицы.
Почему вы получили меньше строк в результате из оператора T-SQL в описании задачи 2,
по сравнению с результатом из оператора T-SQL в описании задачи 1?
6. В операторе T-SQL задачи 2 внутреннее соединение использовало предложение ON на основе информации о менеджере (столбец mgrid). У сотрудника, который является генеральным директором, отсутствует значение в столбце mgrid, поэтому эта строка не
включена в результат
