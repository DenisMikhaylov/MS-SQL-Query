Лабораторная работа: Группировка и агрегация данных
```
Сценарий
Вы — бизнес-аналитик Adventure Works, который будет писать отчеты с использованием корпоративных баз данных,
хранящихся в SQL Server. Вам был предоставлен набор бизнес-требований к данным, и вы будете писать запросы TSQL для их извлечения из баз данных.
Вам нужно будет выполнять вычисления по группам данных
и фильтровать в соответствии с результатами.
Цели
После завершения этой лабораторной работы вы сможете:
 Писать запросы, использующие предложение GROUP BY.
 Писать запросы, использующие агрегатные функции.
 Писать запросы, использующие отдельные агрегатные функции.
 Писать запросы, фильтрующие группы с помощью предложения HAVING.
Расчетное время: 60 минут
Виртуальная машина: 20761C-MIA-SQL
Имя пользователя: ADVENTUREWORKS\Student
Пароль: Pa55w.rd
```
Упражнение 1: Написание запросов, использующих предложение GROUP BY
```
Сценарий
Отдел продаж хочет создать дополнительные возможности для дополнительных продаж от существующих клиентов. Сотрудникам
необходимо проанализировать различные группы клиентов и категории продуктов в зависимости от нескольких бизнес-правил. 
На основе этих правил вы напишете операторы SELECT для извлечения необходимых строк из таблицы
Sales.Customers.
Основные задачи для этого упражнения следующие:
1. Подготовка лабораторной среды
2. Написание оператора SELECT для извлечения различных групп клиентов
3. Добавление дополнительного столбца из таблицы Sales.Customers
4. Написание оператора SELECT для извлечения клиентов с заказами за каждый год
5. Написание оператора SELECT для извлечения групп категорий продуктов, проданных в определенном году
```
```
 Задача 1: Подготовка лабораторной среды
1. Убедитесь, что виртуальные машины 20761C-MIA-DC и 20761C-MIA-SQL обе запущены, а затем войдите в 20761C-MIA-SQL как
2. ADVENTUREWORKS\Student с паролем Pa55w.rd.
3. Запустите Setup.cmd в папке D:\Labfiles\Lab09\Starter как администратор.

 Задача 2: Напишите оператор SELECT для извлечения различных групп клиентов
1. Откройте файл проекта D:\Labfiles\Lab09\Starter\Project\Project.ssmssln и скрипт T-SQL 51 -
Лабораторное упражнение 1.sql. Убедитесь, что вы подключены к базе данных TSQL.
2. Напишите оператор SELECT, который вернет группы клиентов, совершивших покупку. Предложение SELECT
должно включать столбец custid из таблицы Sales.Orders и столбец contactname
из таблицы Sales.Customers. Сгруппируйте оба столбца и отфильтруйте только заказы от
того торгового сотрудника, empid которого равен пяти.
3. Выполните написанный оператор и сравните полученные результаты с желаемыми результатами,
показанными в файле D:\Labfiles\Lab09\Solution\52 - Лабораторное упражнение 1 - Задача 2 Result.txt.

 Задача 3: Добавить дополнительный столбец из таблицы Sales.Customers
1. Скопируйте оператор T-SQL в задаче 1 и измените его, включив столбец города из таблицы Sales.Customers в предложение SELECT.
2. Выполните запрос.
3. Вы получите ошибку. Что это за сообщение об ошибке? Почему?
4. Исправьте запрос, чтобы он выполнялся правильно.
5. Выполните запрос и сравните полученные результаты с желаемыми результатами, показанными в файле
6.  D:\Labfiles\Lab09\Solution\53 - Lab Exercise 1 - Task 3 Result.txt.

 Задача 4: Напишите оператор SELECT для извлечения клиентов с заказами за каждый
год
1. Напишите оператор SELECT, который будет возвращать группы строк на основе столбца custid и вычисляемого столбца orderyear,
представляющего год заказа на основе столбца orderdate из
таблицы Sales.Orders. Отфильтруйте результаты, чтобы включить только заказы от сотрудника отдела продаж, empid
которого равен пяти.
2. Выполните написанный оператор и сравните полученные результаты с желаемыми результатами,
показанными в файле D:\Labfiles\Lab09\Solution\54 - Lab Exercise 1 - Task 4 Result.txt.

 Задача 5: Напишите оператор SELECT для извлечения групп категорий продуктов, проданных в
определенном году
1. Напишите оператор SELECT для извлечения групп строк на основе столбца categoryname в
таблице Production.Categories. Отфильтруйте результаты, чтобы включить только категории продуктов, которые были заказаны в 2008 году.
2. Выполните письменное заявление и сравните полученные результаты с желаемыми результатами, показанными в файле
D:\Labfiles\Lab09\Solution\55 - Lab Exercise 1 - Task 5 Result.txt.
```
Упражнение 2: Написание запросов, использующих агрегатные функции

```
Сценарий
Отдел маркетинга хочет запустить новую кампанию, поэтому сотрудникам необходимо лучше понять
поведение покупателей. Вам следует создать различные отчеты о продажах на основе общей и
средней суммы продаж за год и на одного покупателя.
Основные задачи для этого упражнения следующие:
1. Написать оператор SELECT для извлечения общей суммы продаж по заказу
2. Добавить дополнительные столбцы
3. Написать оператор SELECT для извлечения значения суммы продаж за месяц
4. Написать оператор SELECT для перечисления всех клиентов с общей суммой продаж и количеством строк заказа
Добавлено
```
```
 Задача 1: Написать оператор SELECT для извлечения общей суммы продаж по заказу
1. Откройте скрипт T-SQL 61 - Лабораторная работа 2.sql. Убедитесь, что вы подключены к базе данных TSQL.
2. Напишите оператор SELECT для извлечения столбца orderid из таблицы Sales.Orders и общей
суммы продаж по orderid. (Подсказка: умножьте столбцы qty и unitprice из таблицы Sales.OrderDetails.) Используйте псевдоним salesamount для вычисляемого столбца. Отсортируйте результат по общей сумме продаж
в порядке убывания.
3. Выполните написанный оператор и сравните полученные результаты с желаемыми результатами,
показанными в файле D:\Labfiles\Lab09\Solution\62 - Lab Exercise 2 - Task 1 Result.txt.

 Задача 2: Добавьте дополнительные столбцы
1. Скопируйте оператор T-SQL в задаче 1 и измените его, включив общее количество строк заказа для каждого
заказа и среднее значение суммы продаж строки заказа в заказе. Используйте псевдонимы nooforderlines
и avgsalesamountperorderline соответственно.
2. Выполните письменное утверждение и сравните полученные результаты с рекомендуемыми
результатами, показанными в файле D:\Labfiles\Lab09\Solution\63 - Lab Exercise 2 - Task 2 Result.txt.

 Задача 3: Напишите оператор SELECT для извлечения значения суммы продаж за месяц
1. Напишите оператор SELECT для извлечения общей суммы продаж за каждый месяц. Предложение SELECT должно
включать вычисляемый столбец с именем yearmonthno (обозначение YYYYMM), основанный на столбце orderdate
в таблице Sales.Orders и общей сумме продаж (умножьте столбцы qty и unitprice
из таблицы Sales.OrderDetails). Упорядочьте результат по вычисляемому столбцу yearmonthno.
2. Выполните письменное утверждение и сравните полученные результаты с рекомендуемым результатом,
показанным в файле D:\Labfiles\Lab09\Solution\64 - Lab Exercise 2 - Task 3 Result.txt.

 Задача 4: Напишите оператор SELECT для перечисления всех клиентов с общей суммой продаж
и количеством добавленных строк заказа
1. Напишите оператор SELECT для извлечения всех клиентов (включая тех, кто не размещал заказы)
и их общей суммой продаж, максимальной суммой продаж на строку заказа и количеством строк заказа.
2. Предложение SELECT должно включать столбцы custid и contactname из таблицы Sales.Customers
и четыре вычисляемых столбца на основе соответствующих агрегатных функций:
a. totalsalesamount, представляющий общую сумму продаж на заказ
b. maxsalesamountperorderline, представляющий максимальную сумму продаж на строку заказа
c. numberofrows, представляющий количество строк (используйте * в функции COUNT)
d. numberoforderlines, представляющее количество строк заказа (используйте столбец orderid в
функции COUNT)
3. Упорядочьте результат по столбцу totalsalesamount.
4. Выполните письменное утверждение и сравните полученные вами результаты с рекомендуемыми
результатами, показанными в файле D:\Labfiles\Lab09\Solution\65 - Lab Exercise 2 - Task 4 Result.txt.
5. Обратите внимание, что строки custid 22 и 57 имеют NULL в столбцах с агрегатными функциями SUM и MAX.
Каковы их значения в столбцах COUNT? Почему они отличаются?
```
Упражнение 3: Написание запросов, использующих отдельные агрегатные функции
```
Сценарий
Отдел маркетинга хочет иметь несколько дополнительных отчетов, которые отображают количество клиентов,
сделавших любой заказ за определенный период времени, и количество клиентов на основе первой буквы в
имени контакта.
Основные задачи для этого упражнения следующие:
1. Измените оператор SELECT для получения количества клиентов
2. Напишите оператор SELECT для анализа сегментов клиентов
3. Напишите оператор SELECT для получения дополнительной статистики продаж
```
```
 Задача 1: Измените оператор SELECT для получения количества клиентов
1. Откройте скрипт T-SQL 71 - Лабораторная работа 3.sql. Убедитесь, что вы подключены к базе данных TSQL.
2. Младший аналитик подготовил оператор T-SQL для получения количества заказов и количества
клиентов для каждого года заказа. Ознакомьтесь с предоставленным оператором T-SQL и выполните его:
SELECT
YEAR(orderdate) AS orderyear,
COUNT(orderid) AS nooforders,
COUNT(custid) AS noofcustomers
FROM Sales.Orders
GROUP BY YEAR(orderdate);
3. Ознакомьтесь с результатами. Обратите внимание, что количество заказов совпадает с количеством клиентов. Почему?
4. Измените оператор T-SQL, чтобы отобразить правильное количество клиентов, разместивших заказ за каждый
год.
5. Выполните письменный оператор и сравните полученные вами результаты с рекомендуемыми
результатами, показанными в файле D:\Labfiles\Lab09\Solution\72 - Lab Exercise 3 - Task 1 Result.txt.

 Задание 2: Напишите оператор SELECT для анализа сегментов клиентов
1. Напишите оператор SELECT для извлечения количества клиентов на основе первой буквы значений в столбце
2. contactname из таблицы Sales.Customers. Добавьте дополнительный столбец, чтобы показать общее количество заказов,
3. размещенных каждой группой клиентов. Используйте псевдонимы firstletter,
noofcustomers и nooforders. Упорядочите результат по столбцу firstletter.
4. Выполните письменное утверждение и сравните полученные результаты с рекомендуемыми результатами,
5. показанными в файле D:\Labfiles\Lab09\Solution\73 - Lab Exercise 3 - Task 2 Result.txt.

 Задание 3: Напишите оператор SELECT для получения дополнительной статистики продаж
1. Скопируйте оператор T-SQL в упражнении 1, задании 5 и измените его, включив следующую информацию
о каждой категории продуктов — общая сумма продаж, количество заказов и средняя сумма продаж на
заказ. Используйте псевдонимы totalsalesamount, nooforders и avgsalesamountperorder соответственно.
2. Выполните написанный оператор и сравните полученные вами результаты с рекомендуемыми
результатами, показанными в файле D:\Labfiles\Lab09\Solution\74 - Lab Exercise 3 - Task 3 Result.txt.
```
Упражнение 4: Написание запросов, фильтрующих группы с помощью предложения HAVING

```
Сценарий
Отделы продаж и маркетинга были удовлетворены отчетами, которые вы предоставили для анализа поведения клиентов. 
Теперь они хотели бы отфильтровать результаты на основе общей суммы продаж и количества
заказов. Поэтому в последнем упражнении вы узнаете, как фильтровать результат на основе агрегированных функций, 
и узнаете, когда использовать предложения WHERE и HAVING.
Основные задачи для этого упражнения следующие:
1. Написать оператор SELECT для извлечения 10 лучших клиентов
2. Написать оператор SELECT для извлечения определенных заказов
3. Применить дополнительную фильтрацию
4. Извлечь клиентов с более чем 25 заказами
```
```
 Задача 1: Написать оператор SELECT для извлечения 10 лучших клиентов
1. Откройте скрипт T-SQL 81 - Лабораторное упражнение 4.sql. Убедитесь, что вы подключены к базе данных TSQL.
2. Напишите оператор SELECT для извлечения 10 лучших клиентов (по общей сумме продаж), которые потратили более
3. 10 000 долларов США. Отобразите столбец custid из таблицы Orders и вычисляемый столбец, который
содержит общую сумму продаж на основе столбцов qty и unitprice из таблицы Sales.OrderDetails. Используйте псевдоним
totalsalesamount для вычисляемого столбца.
5. Выполните письменный оператор и сравните полученные результаты с рекомендуемыми
результатами, показанными в файле D:\Labfiles\Lab09\Solution\82 - Lab Exercise 4 - Task 1 Result.txt.

 Задача 2: Напишите оператор SELECT для извлечения определенных заказов
1. Напишите оператор SELECT для таблиц Sales.Orders и Sales.OrderDetails и отобразите столбец empid и вычисляемый
2. столбец, представляющий общую сумму продаж. Отфильтруйте результаты, чтобы
сгруппировать только строки с годом заказа 2008.
3. Выполните письменное утверждение и сравните полученные результаты с рекомендуемыми
результатами, показанными в файле D:\Labfiles\Lab09\Solution\83 - Lab Exercise 4 - Task 2 Result.txt.

 Задача 3: Примените дополнительную фильтрацию
1. Скопируйте оператор T-SQL в задании 2 и измените его, чтобы применить дополнительный фильтр для извлечения только
строк, имеющих сумму продаж выше 10 000 долларов США.
2. Выполните письменное утверждение и сравните полученные результаты с рекомендуемыми
результатами, показанными в файле D:\Labfiles\Lab09\Solution\84 - Lab Exercise 4 - Task 3_1 Result.txt.
3. Примените дополнительный фильтр, чтобы показать только сотрудников с empid, равным 3.
4. Выполните письменное утверждение и сравните полученные результаты с рекомендуемыми
результатами, показанными в файле D:\Labfiles\Lab09\Solution\85 - Lab Exercise 4 - Task 3_2 Result.txt.
5. Вы применили логику предикатов в предложении WHERE или в предложении HAVING? Что, по вашему мнению, лучше?
Почему?

 Задача 4: Извлечение клиентов с более чем 25 заказами
1. Напишите утверждение SELECT, чтобы извлечь всех клиентов, которые разместили более 25 заказов, и добавьте
информацию о дате последнего заказа и общей сумме продаж. Отобразите столбец custid
из таблицы Sales.Orders и два вычисляемых столбца — lastorderdate на основе столбца orderdate
и totalsalesamount на основе столбцов qty и unitprice в таблице Sales.OrderDetails.
2. Выполните письменное утверждение и сравните полученные результаты с рекомендуемым
результатом, показанным в файле D:\Labfiles\Lab09\Solution\86 - Lab Exercise 4 - Task 4 Result.txt.
3. Закройте SQL Server Management Studio, не сохраняя никаких файлов.
```
