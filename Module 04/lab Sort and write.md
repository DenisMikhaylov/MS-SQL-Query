Лабораторная работа: Сортировка и фильтрация данных

Сценарий

Вы — бизнес-аналитик Adventure Works, который будет писать отчеты, используя корпоративные базы данных,
хранящиеся в SQL Server. Вам был предоставлен набор бизнес-требований к данным, и вы будете писать запросы TSQL для извлечения указанных данных из баз данных. Вам нужно будет извлечь только некоторые из
доступных данных и вернуть их в свои отчеты в указанном порядке.


Цели
После завершения этой лабораторной работы вы сможете:
 Писать запросы, которые фильтруют данные с помощью предложения WHERE.
 Писать запросы, которые сортируют данные с помощью предложения ORDER BY.
 Писать запросы, которые фильтруют данные с помощью параметра TOP.
 Писать запросы, которые фильтруют данные с помощью предложения OFFSET-FETCH.
Расчетное время: 60 минут
Виртуальная машина: 20761C-MIA-SQL
Имя пользователя: ADVENTUREWORKS\Student
Пароль: Pa55w.rd


Упражнение 1: Написание запросов, фильтрующих данные с использованием предложения WHERE

```
Сценарий
Отдел маркетинга работает над несколькими кампаниями для существующих клиентов, и сотрудникам необходимо
получить различные списки клиентов в зависимости от нескольких бизнес-правил. На основе этих правил вы
напишете операторы SELECT для извлечения необходимых строк из таблицы Sales.Customers.
Основные задачи для этого упражнения следующие:
1. Подготовка лабораторной среды
2. Написание оператора SELECT с использованием предложения WHERE
3. Написание оператора SELECT с использованием предиката IN в предложении WHERE
4. Написание оператора SELECT с использованием предиката LIKE в предложении WHERE
5. Соблюдение оператора T-SQL, предоставленного ИТ-отделом
6. Написание оператора SELECT для извлечения клиентов без заказов
```
```
 Задача 1: Подготовка лабораторной среды
1. Убедитесь, что виртуальные машины 20761C-MIA-DC и 20761C-MIA-SQL обе запущены, а затем войдите в
20761C-MIA-SQL как ADVENTUREWORKS\Student с паролем Pa55w.rd.
2. Запустите Setup.cmd в папке D:\Labfiles\Lab05\Starter как администратор.

 Задание 2: Напишите оператор SELECT с использованием предложения WHERE
1. Откройте файл проекта D:\Labfiles\Lab05\Starter\Project\Project.ssmssln и скрипт T-SQL 51 -
Лабораторное упражнение 1.sql. Убедитесь, что вы подключены к базе данных TSQL.
2. Напишите оператор SELECT, который вернет столбцы custid, companyname, contactname, address, city,
country и phone из таблицы Sales.Customers. Отфильтруйте результаты, чтобы включить только
клиентов из страны Бразилия.
3. Выполните написанное выражение и сравните полученные результаты с желаемыми результатами,
показанными в файле D:\Labfiles\Lab05\Solution\52 - Лабораторное упражнение 1 - Задача 1 Result.txt.

 Задание 3: Напишите оператор SELECT с использованием предиката IN в предложении WHERE
1. Напишите оператор SELECT, который вернет столбцы custid, companyname, contactname, address, city,
country и phone из таблицы Sales.Customers. Отфильтруйте результаты, чтобы включить только
клиентов из стран Бразилия, Великобритания и США.
2. Выполните написанный оператор и сравните полученные результаты с желаемыми результатами,
показанными в файле D:\Labfiles\Lab05\Solution\53 - Lab Exercise 1 - Task 2 Result.txt.

 Задание 4: Напишите оператор SELECT с использованием предиката LIKE в предложении WHERE
1. Напишите оператор SELECT, который вернет столбцы custid, companyname, contactname, address, city,
country и phone из таблицы Sales.Customers. Отфильтруйте результаты, чтобы включить только
клиентов с контактным именем, начинающимся с буквы A.
2. Выполните письменное утверждение и сравните полученные результаты с желаемыми результатами,
показанными в файле D:\Labfiles\Lab05\Solution\54 - Lab Exercise 1 - Task 3 Result.txt.

 Задача 5: Изучите утверждение T-SQL, предоставленное ИТ-отделом
1. ИТ-отдел написал утверждение T-SQL, которое извлекает столбцы custid и companyname из таблицы Sales.Customers и столбец
orderid из таблицы Sales.Orders:
SELECT
c.custid, c.companyname, o.orderid
FROM Sales.Customers AS c
LEFT OUTER JOIN Sales.Orders AS o ON c.custid = o.custid AND c.city = N'Paris';
2. Выполните запрос и обратите внимание на две вещи: во-первых, запрос извлекает все строки из таблицы
Sales.Customers. Во-вторых, в предложении ON есть оператор сравнения, указывающий, что
столбец city должен быть равен значению «Париж».

3. Скопируйте предоставленный оператор T-SQL и измените его, чтобы в предложении WHERE был оператор сравнения для столбца city.
Выполните запрос.

4. Сравните полученные результаты с желаемыми результатами, показанными в файлах
D:\Labfiles\Lab05\Solution\55 - Lab Exercise 1 - Task 4a Result.txt и D:\Labfiles\Lab05\Solution\56 -
Lab Exercise 1 - Task 4b Result.txt.

5. Результат такой же, как в первом предложении T-SQL? Почему? В чем разница между указанием
предиката в предложении ON и в предложении WHERE?

Задание 6: Напишите оператор SELECT для извлечения клиентов без заказов
1. Напишите оператор T-SQL для извлечения клиентов из таблицы Sales.Customers, у которых нет соответствующих заказов в таблице Sales.Orders. Сопоставление клиентов с заказами основано на сравнении
значений custid клиента и заказа. Извлеките столбцы custid и companyname из таблицы Sales.Customers. (Подсказка: используйте оператор T-SQL, аналогичный тому, что был в предыдущей задаче.)
2. Выполните написанный оператор и сравните полученные результаты с желаемыми результатами,
показанными в файле D:\Labfiles\Lab05\Solution\57 - Lab Exercise 1 - Task 5 Result.txt.
```
Упражнение 2: Написание запросов, сортирующих данные с использованием предложения ORDER BY
```
Сценарий
Отдел продаж хотел бы получить отчет, показывающий все заказы с некоторой информацией о клиентах.
Дополнительный запрос заключается в том, чтобы результат был отсортирован по датам заказов и идентификаторам клиентов. Из предыдущих
модулей помните, что порядок строк в выводе запроса без предложения ORDER BY
не гарантируется. Из-за этого вам придется написать оператор SELECT, который использует предложение ORDER BY.
Основные задачи для этого упражнения следующие:
1. Написать оператор SELECT с использованием предложения ORDER BY
2. Применить необходимые изменения и выполнить оператор T-SQL
3. Упорядочить результат по столбцу firstname
```
```
 Задача 1: Написать оператор SELECT с использованием предложения ORDER BY
1. Откройте скрипт T-SQL 61 - Лабораторная работа 2.sql и убедитесь, что вы подключены к базе данных TSQL.
2. Напишите оператор SELECT для извлечения столбцов custid и contactname из таблицы Sales.Customers и столбцов orderid и orderdate из таблицы Sales.Orders. Отфильтруйте
результаты, чтобы включить только заказы, размещенные 1 апреля 2008 г. или позже (отфильтруйте столбец orderdate), затем
отсортируйте результат по orderdate в порядке убывания и custid в порядке возрастания.
3. Выполните написанный оператор и сравните полученные результаты с желаемыми результатами,
показанными в файле D:\Labfiles\Lab05\Solution\62 - Lab Exercise 2 - Task 1 Result.txt.

 Задача 2: Применить необходимые изменения и выполнить оператор T-SQL
1. Кто-то взял ваш оператор T-SQL из лабораторной работы 4 и добавил следующее предложение WHERE:
SELECT
e.empid, e.lastname, e.firstname, e.title, e.mgrid,
m.lastname AS mgrlastname, m.firstname AS mgrfirstname
FROM HR.Employees AS e
INNER JOIN HR.Employees AS m ON e.mgrid = m.empid
WHERE mgrlastname = 'Buck';
2. Выполните запрос точно так, как он написан в окне запроса, и посмотрите на результат.
3. Возникла ошибка. Что за сообщение об ошибке? Как вы думаете, почему это произошло? (Совет: запомните логический порядок обработки запроса.)
4. Примените необходимые изменения к оператору SELECT, чтобы он выполнялся без ошибок. Проверьте
изменения, выполнив оператор T-SQL.
5. Наблюдайте и сравните полученные вами результаты с рекомендуемыми результатами, показанными в
D:\Labfiles\Lab05\Solution\63 - Lab Exercise 2 - Task 2 Result.txt.

 Задача 3: упорядочение результата по столбцу firstname
1. Скопируйте существующий оператор T-SQL из задачи 2 и измените его так, чтобы результат возвращал всех
сотрудников и был упорядочен по имени менеджера. Сначала попробуйте использовать имя исходного столбца, а
затем псевдоним столбца.
2. Выполните написанный оператор и сравните полученные вами результаты с рекомендуемыми
результатами, показанными в файле D:\Labfiles\Lab05\Solution\64 - Lab Exercise 2 - Task 3a и 3b Result.txt.
3. Почему вы смогли использовать исходный столбец или псевдоним столбца?
```
Упражнение 3: Написание запросов, фильтрующих данные с использованием параметра TOP
```
Сценарий
Отдел продаж хочет иметь несколько дополнительных отчетов, которые показывают последние заказы с выставленными счетами и 10 процентов самых дорогих проданных продуктов.
Основные задачи для этого упражнения следующие:
1. Написание запросов, фильтрующих данные с использованием предложения TOP
2. Использование предложения OFFSET-FETCH для реализации той же задачи
3. Написание оператора SELECT для извлечения самых дорогих продуктов
```
```
 Задача 1: Написание запросов, фильтрующих данные с использованием предложения TOP
1. Откройте скрипт T-SQL 71 - Лабораторная работа 3.sql. Убедитесь, что вы подключены к базе данных TSQL.
2. Напишите оператор SELECT для таблицы Sales.Orders и извлеките столбцы orderid и orderdate. Извлеките 20 последних заказов, упорядоченных по orderdate.
3. Выполните письменное выражение и сравните полученные результаты с рекомендуемым
результатом, показанным в файле 72 - Lab Exercise 3 - Task 1 Result.txt.

 Задание 2: Используйте предложение OFFSET-FETCH для реализации того же задания
1. Напишите выражение SELECT для получения того же результата, что и в задании 1, но используйте предложение OFFSET-FETCH.
2. Выполните письменное выражение и сравните полученные результаты с результатами из задания 1.
3. Сравните полученные результаты с рекомендуемым результатом, показанным в файле 73 - Lab
Exercise 3 - Task 2 Result.txt.

 Задание 3: Напишите выражение SELECT для получения самых дорогих продуктов
1. Напишите выражение SELECT для получения столбцов productname и unitprice из таблицы
Production.Products.
2. Выполните оператор T-SQL и обратите внимание на количество возвращенных строк.
3. Измените оператор SELECT, чтобы включить только верхние 10 процентов продуктов на основе заказа по цене за единицу.
4. Выполните написанный оператор и сравните полученные результаты с рекомендуемым результатом, показанным в файле 74 - Лабораторное упражнение 3 - Задача 3 Result.txt. Обратите внимание на количество возвращенных строк.
5. Возможно ли реализовать эту задачу с помощью предложения OFFSET-FETCH?
