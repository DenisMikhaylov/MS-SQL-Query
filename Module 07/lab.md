Лаборатория: Использование подзапросов
```
СценарийВы работаете бизнес-аналитиком в компании Adventure Works и создаете отчёты, используя корпоративные базы данных, хранящиеся в SQL Server. Вам предоставлены требования бизнеса относительно необходимой информации, и вам предстоит написать запросы на T-SQL для извлечения указанных данных из баз данных. Из-за сложности некоторых запросов вам потребуется внедрять подзапросы в ваши запросы, чтобы возвращать результаты одним запросом.

ЦелиПо завершении этой лаборатории вы сможете:

Писать запросы, использующие подзапросы.
Писать запросы, использующие скалярные и многострочные подзапросы.
Писать запросы, использующие коррелированные подзапросы и предикат EXISTS.
Примерное время: 60 минут

Виртуальная машина: 20761C-MIA-SQL

Имя пользователя: AdventureWorks\Student

Пароль: Pa55w.rd
```
Упражнение 1: Написание запросов, использующих автономные подзапросы
```
СценарийОтдел продаж нуждается в продвинутых отчетах для анализа заказов. Вы будете писать разные операторы SELECT, использующие автономные подзапросы.

Основные задачи этого упражнения включают следующее:

Подготовьте лабораторную среду.
Напишите оператор SELECT для получения последней даты заказа.
Напишите оператор SELECT для выборки всех заказов, размещенных на последнюю дату заказа.
Ознакомьтесь с оператором T-SQL, предоставленным ИТ-отделом.
Напишите оператор SELECT для анализа каждой продажи как процента от общей суммы продаж.
```
```
✔️ Задача 1: Подготовка лабораторной среды

Убедитесь, что виртуальные машины 20761C-MIA-DC и 20761C-MIA-SQL запущены, затем войдите в систему на машине 20761C-MIA-SQL как ADVENTUREWORKS\Student с паролем Pa55w.rd.
Запустите файл Setup.cmd в папке D:\Labfiles\Lab10\Starter от имени администратора.

✔️ Задача 2: Написание оператора SELECT для получения последней даты заказа

Откройте проект-файл D:\Labfiles\Lab10\Starter\Project\Project.ssmssln и скрипт T-SQL 51-Lab Exercise 1.sql. Убедитесь, что вы подключены к базе данных TSQL.
Напишите оператор SELECT для возврата максимальной даты заказа из таблицы Sales.Orders.
Выполните написанный вами оператор и сравните полученные результаты с требуемыми результатами, показанными в файле D:\Labfiles\Lab10\Solution\52 - Lab Exercise 1 - Task 1 Result.txt

✔️ Задача 3: Написание оператора SELECT для получения всех заказов, сделанных на последнюю дату заказа

Напишите оператор SELECT для возвращения столбцов orderid, orderdate, empid и custid из таблицы Sales.Orders. Отфильтруйте результаты таким образом, чтобы включить только заказы, дата которых равна последней дате заказа. (Подсказка: используйте запрос из задания 1 в качестве автономного подзапроса.)
Выполните написанный вами оператор и сравните полученные результаты с требуемыми результатами, указанными в файле D:\Labfiles\Lab10\Solution\53 - Lab Exercise 1 - Task 2 Result.txt.

✔️ Задача 4: Просмотр оператора T-SQL, предоставленного отделом ИТ

Отдел ИТ написал оператор T-SQL, извлекающий заказы всех клиентов, чьё контактное лицо начинается с буквы 'I':

SELECT
   orderid, orderdate, empid, custid
FROM Sales.Orders
WHERE
   custid = (
      SELECT custid
      FROM Sales.Customers
      WHERE contactname LIKE N'I%'
   );
Выполните этот запрос и посмотрите на результат.
Измените запрос так, чтобы фильтровать клиентов, чьё контактное лицо начинается с буквы 'B'.
Выполните запрос. Что произошло? Какое сообщение об ошибке появилось? Почему запрос завершился неудачей?
Примените необходимые изменения к оператору T-SQL, чтобы он выполнялся без ошибок.
Выполните исправленный оператор и сравните полученные результаты с требуемыми результатами, указанными в файле D:\Labfiles\Lab10\Solution\54 - Lab Exercise 1 - Task 3 Result.txt.

✔️ Задача 5: Написание оператора SELECT для анализа каждого заказа как процентной доли от общей суммы продаж

Напишите оператор SELECT для возвращения столбца orderid из таблицы Sales.Orders и следующих вычисляемых столбцов:
totalsalesamount (основан на значениях столбцов qty и unitprice в таблице Sales.OrderDetails).
salespctoftotal (процент общей суммы продаж для каждого заказа, поделённый на общую сумму продаж за определённый период).
Фильтруйте результаты, включая только заказы, сделанные в мае 2008 года.
Выполните написанный вами оператор и сравните полученные результаты с требуемыми результатами, указанными в файле D:\Labfiles\Lab10\Solution\55 - Lab Exercise 1 - Task 4 Result.txt.
```
Упражнение 2: Написание запросов, использующих скалярные и многострочные подзапросы
```
СценарийМаркетинговый отдел хочет подготовить материалы для разных групп продуктов и клиентов, основываясь на исторических данных о продажах. Вам предстоит подготовить различные операторы SELECT, использующие подзапрос в предложении WHERE.

Основные задачи этого упражнения включают следующее:

Написание оператора SELECT для получения конкретных товаров.
Написание оператора SELECT для получения тех клиентов, у которых нет заказов.
Добавление строки и повторное выполнение запроса, выбирающего клиентов без заказов.
```
```
✔️ Задача 1: Написание оператора SELECT для получения конкретных товаров

Откройте скрипт T-SQL 61-Lab Exercise 2.sql. Убедитесь, что вы подключены к базе данных TSQL.
Напишите оператор SELECT для выбора столбцов productid и productname из таблицы Production.Products. Отфильтруйте результаты, включив только товары, проданные большими количествами (более 100 штук) на конкретной строке заказа.
Выполните написанный вами оператор и сравните полученные результаты с рекомендуемыми результатами, представленными в файле D:\Labfiles\Lab10\Solution\62 - Lab Exercise 2 - Task 1 Result.txt.

✔️ Задача 2: Написание оператора SELECT для получения клиентов без заказов

Напишите оператор SELECT для выбора столбцов custid и contactname из таблицы Sales.Customers. Отфильтруйте результаты, включив только тех клиентов, у которых нет ни одного размещённого заказа.
Выполните написанный вами оператор и сравните полученные результаты с рекомендованными результатами, представленными в файле D:\Labfiles\Lab10\Solution\63 - Lab Exercise 2 - Task 2 Result.txt. Обратите внимание на количество строк в результатах.

✔️ Задача 3: Добавление строки и повторное выполнение запроса, выбирающего клиентов без заказов

Отдел ИТ предоставил оператор T-SQL, вставляющий дополнительную строку в таблицу Sales.Orders. Эта строка имеет значение NULL в столбце custid:
```
```
INSERT INTO Sales.Orders (
   custid, empid, orderdate, requireddate, shippeddate, shipperid, freight,
   shipname, shipaddress, shipcity, shipregion, shippostalcode, shipcountry)
VALUES
(NULL, 1, '20111231', '20111231', '20111231', 1, 0,
'ShipOne', 'ShipAddress', 'ShipCity', 'RA', '1000', 'USA');
```
```
Выполните этот запрос точно так же, как написано, внутри окна запроса.
Скопируйте оператор T-SQL, который вы написали в задаче 2, и выполните его снова.
Посмотрите на результат. Сколько строк содержится в результате? Почему?
Измените оператор T-SQL так, чтобы вернуть такое же количество строк, как в задаче 2. (Подсказка: вам придётся исключить строки с неизвестным значением в столбце custid.)
Выполните измененный оператор и сравните полученные результаты с рекомендуемыми результатами, представленными в файле D:\Labfiles\Lab10\Solution\64 - Lab Exercise 2 - Task 3 Result.txt.
```
Упражнение 3: Написание запросов, использующих коррелированные подзапросы и предикат EXISTS
```
СценарийОтдел продаж хотел бы иметь дополнительные отчеты для отображения различных анализов существующих клиентов. Поскольку запросы являются сложными, вам понадобится использовать коррелированные подзапросы.

Основные задачи этого упражнения включают следующее:

Написание оператора SELECT для получения последней даты заказа для каждого клиента.
Написание оператора SELECT, использующего предикат EXISTS для получения клиентов без заказов.
Написание оператора SELECT для получения клиентов, купивших дорогие продукты.
Написание оператора SELECT для отображения общей суммы продаж и накопительной суммы продаж для каждого года заказов.
Очистка таблицы Sales.Customers.

✔️ Задача 1: Написание оператора SELECT для получения последней даты заказа для каждого клиента

Откройте скрипт T-SQL 71-Lab Exercise 3.sql. Убедитесь, что вы подключены к базе данных TSQL.
Напишите оператор SELECT для выборки столбцов custid и contactname из таблицы Sales.Customers. Добавьте вычисляемый столбец с именем lastorderdate, содержащий последнюю дату заказа из таблицы Sales.Orders для каждого клиента. (Подсказка: вам придется использовать коррелированный подзапрос.)
Выполните написанный вами оператор и сравните полученные результаты с рекомендуемыми результатами, представленными в файле D:\Labfiles\Lab10\Solution\72 - Lab Exercise 3 - Task 1 Result.txt.

✔️ Задача 2: Написание оператора SELECT, использующего предикат EXISTS для получения клиентов без заказов

Напишите оператор SELECT для выборки всех клиентов, у которых нет заказов в таблице Sales.Orders, аналогично запросу из упражнения 2, задача 3. Однако на этот раз используйте предикат EXISTS для фильтрации результатов, включающих только тех клиентов, у которых нет заказов. Также вам не нужно явно проверять, что столбец custid в таблице Sales.Orders не равен NULL.
Выполните написанный вами оператор и сравните полученные результаты с рекомендуемыми результатами, представленными в файле D:\Labfiles\Lab10\Solution\73 - Lab Exercise 3 - Task 2 Result.txt.
Почему вам не пришлось проверять наличие значения NULL?

✔️ Задача 3: Написание оператора SELECT для получения клиентов, купивших дорогие продукты

Напишите оператор SELECT для выборки столбцов custid и contactname из таблицы Sales.Customers. Отфильтруйте результаты, включив только тех клиентов, которые разместили заказ после или начиная с 1 апреля 2008 года и купили продукт стоимостью выше $100.
Выполните написанный вами оператор и сравните полученные результаты с рекомендуемыми результатами, представленными в файле D:\Labfiles\Lab10\Solution\74 - Lab Exercise 3 - Task 3 Result.txt.

✔️ Задача 4: Написание оператора SELECT для отображения общей суммы продаж и нарастающей итоговой суммы продаж по каждому году заказов

Нарастающие итоги накапливают значения с течением времени. Напишите оператор SELECT для вывода следующей информации по каждому году:
Год заказа.
Общая сумма продаж.
Нарастающая общая сумма продаж по годам. То есть для каждого года верните сумму продаж вплоть до этого года. Например, для самого раннего года (2006 г.) возвратите общую сумму продаж; для следующего года (2007 г.) возвратите сумму общей суммы продаж предыдущего года плюс 2007 год.
Оператор SELECT должен содержать три вычисляемые столбца:
orderyear — представляет собой год заказа. Этот столбец должен быть основан на столбце orderyear из таблицы Sales.Orders.
totalsales — представляет собой общую сумму продаж за каждый год. Этот столбец должен быть основан на столбцах qty и unitprice из таблицы Sales.OrderDetails.
runsales — представляет собой нарастающую сумму продаж. Этот столбец должен использовать коррелированный подзапрос.
Выполните код T-SQL и сравните полученные результаты с рекомендуемыми результатами, представленными в файле D:\Labfiles\Lab10\Solution\75 - Lab Exercise 3 - Task 4 Result.txt.

✔️ Задача 5: Очистка таблицы Sales.Customers

Удалите строку, добавленную в упражнении 2, используя следующий SQL-запрос:

DELETE Sales.Orders
WHERE custid IS NULL;
Выполните этот запрос точно так же, как написано, внутри окна запроса.
```
